#+TITLE: CalibrePluginScaleATon

* CalibrePluginScaleATon

A skeleton that "tries" to be a basis for practical calibre plugin creation.

* memo

  github's org-mode renderer will not render this correctly!

** where we are

   #+begin_src sh :eval never
   lsb_release -a
   #+end_src

   #+RESULTS:
   | Distributor ID: | Ubuntu             |
   | Description:    | Ubuntu 12.04.1 LTS |
   | Release:        | 12.04              |
   | Codename:       | precise            |


   #+begin_src sh :results output :eval never
   calibredb --version
   #+end_src

   #+RESULTS:
   : calibredb (calibre 0.9.11)

   #+begin_src sh :results output
   python -c 'import sys; print sys.version_info'
   #+end_src

   #+RESULTS:
   : sys.version_info(major=2, minor=7, micro=3, releaselevel='final', serial=0)

** where we want to go

   - add a menu entry to right click that says "Get info"
   - when you click it, it prints the dict of the book entry
     
** version 1

   ref: http://manual.calibre-ebook.com/creating_plugins.html

   first code in the tutorial involves importing calibre:

   #+begin_src python :eval never
     import os
     from calibre.customize import FileTypePlugin
   #+end_src

   #+RESULTS:
   : Traceback (most recent call last):
   :   File "<stdin>", line 7, in <module>
   :   File "<stdin>", line 4, in main
   : ImportError: No module named calibre.customize
   
   So we need to set up calibre as an importable module...

*** set up our development environment

    ref: http://manual.calibre-ebook.com/develop.html

**** set up a virtualenv

     #+begin_src sh :eval never
     virtualenv venv
     #+end_src

     #+RESULTS:
     : New python executable in venv/bin/python
     : Installing setuptools............done.
     : Installing pip...............done.

**** get calibre src for python import

     make sure we have a copy of the bazaar code somewhere. skipping this part -- you want to follow develop.html linked above.

     mine is sitting in =~/dev/calibre/calibre-src=; make sure you run =bzr merge= to update it.

     #+begin_src sh :results output :eval never
     grep -n numeric_version ~/dev/calibre/calibre-src/src/calibre/constants.py
     #+end_src

     #+RESULTS:
     : 7:numeric_version = (0, 9, 11)
     : 8:__version__   = u'.'.join(map(unicode, numeric_version))

**** =.pth= file hacks for calibre import

     #+begin_src sh :results output :eval never
     cat venv/lib/python2.7/site-packages/calibre.pth
     #+end_src

     #+RESULTS:
     : import os, sys; sys.path.append(os.path.expanduser("~/dev/calibre/calibre-src/src"))
     : import os, sys; sys.resources_location = os.path.expanduser("~/dev/calibre/calibre-src/resources")
     : import os, sys; sys.extensions_location = os.path.abspath("~/dev/calibre/calibre-src/src/calibre/plugins")
     : import sys; sys.executables_location = "/usr/bin"

     now attempt import calibre

     #+begin_src sh :results output
     . venv/bin/activate
     python -c 'import calibre'
     #+end_src

     #+RESULTS:
     : Loading ICU failed with:  No module named icu
     : Loading ICU failed with:  No module named icu

**** install =PyICU=

     #+begin_src sh :results output :eval never
     . venv/bin/activate
     pip install PyICU
     #+end_src

     #+RESULTS:
     #+begin_example
       Downloading/unpacking PyICU
         Running setup.py egg_info for package PyICU
       
       Installing collected packages: PyICU
         Running setup.py install for PyICU
           building '_icu' extension
           gcc -pthread -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -fPIC -I/usr/include/python2.7 -c numberformat.cpp -o build/temp.linux-x86_64-2.7/numberformat.o -DPYICU_VER="1.5"
           # ... #
           # ... # elided
           # ... #
           g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-Bsymbolic-functions -Wl,-z,relro build/temp.linux-x86_64-2.7/numberformat.o build/temp.linux-x86_64-2.7/format.o build/temp.linux-x86_64-2.7/unicodeset.o build/temp.linux-x86_64-2.7/bases.o build/temp.linux-x86_64-2.7/normalizer.o build/temp.linux-x86_64-2.7/tzinfo.o build/temp.linux-x86_64-2.7/layoutengine.o build/temp.linux-x86_64-2.7/charset.o build/temp.linux-x86_64-2.7/locale.o build/temp.linux-x86_64-2.7/iterators.o build/temp.linux-x86_64-2.7/collator.o build/temp.linux-x86_64-2.7/common.o build/temp.linux-x86_64-2.7/calendar.o build/temp.linux-x86_64-2.7/dateformat.o build/temp.linux-x86_64-2.7/search.o build/temp.linux-x86_64-2.7/_icu.o build/temp.linux-x86_64-2.7/regex.o build/temp.linux-x86_64-2.7/transliterator.o build/temp.linux-x86_64-2.7/errors.o -licui18n -licuuc -licudata -licule -o build/lib.linux-x86_64-2.7/_icu.so
       
       Successfully installed PyICU
       Cleaning up...
     #+end_example

     #+begin_src sh :results output :eval never
     . venv/bin/activate
     python -c 'import calibre; print "OK"'
     #+end_src

     #+RESULTS:
     : OK

     there was actually a problem before, where =src/calibre/utils/icu.py= printed "icu not ok". I placed a =print _icu= after the =if _icu is None= test, and the error went away. presumably something was stale and updating it reloaded something else that propagated the fix.

*** test out our environment

     #+begin_src sh :results output :eval never
     . venv/bin/activate
     python -c 'import os; from calibre.customize import FileTypePlugin; print "OK"'
     #+end_src

     #+RESULTS:
     : OK

*** test the HelloWorld plugin

    #+begin_src sh :results silent :eval never
    mkdir HelloWorldPlugin
    #+end_src

    (run =C-v-t= or =(org-babel-tangle)= to generate this file) 

    #+begin_src python :tangle HelloWorldPlugin/__init__.py :eval never
      import os
      from calibre.customize import FileTypePlugin
      
      class HelloWorld(FileTypePlugin):
      
          name                = 'Hello World Plugin' # Name of the plugin
          description         = 'Set the publisher to Hello World for all new conversions'
          supported_platforms = ['windows', 'osx', 'linux'] # Platforms this plugin will run on
          author              = 'Acme Inc.' # The author of this plugin
          version             = (1, 0, 0)   # The version number of this plugin
          file_types          = set(['epub', 'mobi']) # The file types that this plugin will be applied to
          on_postprocess      = True # Run this plugin after conversion is complete
          minimum_calibre_version = (0, 7, 53)
      
          def run(self, path_to_ebook):
              from calibre.ebooks.metadata.meta import get_metadata, set_metadata
              file = open(path_to_ebook, 'r+b')
              ext  = os.path.splitext(path_to_ebook)[-1][1:].lower()
              mi = get_metadata(file, ext)
              mi.publisher = 'Hello World'
              set_metadata(file, mi, ext)
              return path_to_ebook
    #+end_src

    this file should be runnable from the venv command line (producing no output)

**** install the HelloWorld plugin
     
     #+begin_src sh :results output :eval never
     calibre-customize -b HelloWorldPlugin
     #+end_src

     #+RESULTS:
     : Plugin updated: Hello World Plugin (1, 0, 0)

     what that did:
     [[./doc/img/ss-001.png]]

*** Right-click menu plugin

    #+begin_src sh :results silent :eval never
    mkdir MyPlugin
    #+end_src

**** plugin-import-name-myplugin.txt

     calibre likes this text file to be empty, but I like to put some install memo in it

     #+begin_src txt :tangle MyPlugin/plugin-import-name-myplugin.txt
     calibre-customize -b MyPlugin
     #+end_src

     Then you can call =sh MyPlugin/*.txt= to deploy it locally. For now we'll do this. Later, we might change it to run the =zip -r= command for bundling

**** __init__.py

     #+begin_src python :tangle MyPlugin/__init__.py
       from calibre.customize import InterfaceActionBase
       
       class MyPlugin(InterfaceActionBase):
       
           name                = 'Right click plugin'
           description         = 'Create an action menu that appears on right click'
           supported_platforms = ['windows', 'osx', 'linux']
           author              = 'Sir Skeleton'
           version             = (0, 0, 1)
           minimum_calibre_version = (0, 7, 53)
       
           actual_plugin       = 'calibre_plugins.myplugin.ui:RightClickPlugin'
       
           def is_customizable(self):
               return True
       
           def config_widget(self):
               from calibre_plugins.myplugin.config import ConfigWidget
               return ConfigWidget()
       
           def save_settings(self, config_widget):
               '''
               Save the settings specified by the user with config_widget.
       
               :param config_widget: The widget returned by :meth:`config_widget`.
               '''
               config_widget.save_settings()
       
               # Apply the changes
               ac = self.actual_plugin_
               if ac is not None:
                   ac.apply_settings()
               
     #+end_src

**** ui.py

     #+begin_src python :tangle MyPlugin/ui.py
       from calibre.gui2.actions import InterfaceAction
       from calibre.gui2 import question_dialog, info_dialog
       
       class RightClickPlugin(InterfaceAction):
       
           name = 'Right Click Menu'
       
           action_spec = ('Right Click Menu', None,
                          'Activate the menu', None) # None = no keyboard shortcut
       
           action_type = 'current'

           def genesis(self):
               # skip the icon creation
               # icon = get_icons('images/icon.png')
               # self.qaction.setIcon(icon)
               self.qaction.triggered.connect(self.show_dialog)
       
           def show_dialog(self):
               # The base plugin object defined in __init__.py
               base_plugin_object = self.interface_action_base_plugin
               # Show the config dialog
               # The config dialog can also be shown from within
               # Preferences->Plugins, which is why the do_user_config
               # method is defined on the base plugin class
               do_user_config = base_plugin_object.do_user_config
       
               # self.gui is the main calibre GUI. It acts as the gateway to access
               # all the elements of the calibre user interface, it should also be the
               # parent of the dialog
               # TODO: add book info
               info_dialog(self.gui, "Item info", str("TODO: add book info"), show=True)
       
           def apply_settings(self):
               from calibre_plugins.myplugin.config import prefs
               # In an actual non trivial plugin, you would probably need to
               # do something based on the settings in prefs
               prefs
       
     #+end_src

**** config.py

     #+begin_src python :tangle MyPlugin/config.py
       from PyQt4.Qt import QWidget, QHBoxLayout, QLabel, QLineEdit
       
       from calibre.utils.config import JSONConfig
       
       # You should always prefix your config file name with plugins/,
       # so as to ensure you dont accidentally clobber a calibre config file
       prefs = JSONConfig('plugins/myplugin')
       
       # Set defaults
       prefs.defaults['my_msg_header'] = 'Your book info:'
       
       class ConfigWidget(QWidget):
       
           def __init__(self):
               QWidget.__init__(self)
               self.l = QHBoxLayout()
               self.setLayout(self.l)
       
               self.label = QLabel('Message header:')
               self.l.addWidget(self.label)
       
               self.msg = QLineEdit(self)
               self.msg.setText(prefs['my_msg_header'])
               self.l.addWidget(self.msg)
               self.label.setBuddy(self.msg)
       
           def save_settings(self):
               prefs['my_msg_header'] = unicode(self.msg.text())
     #+end_src

*** Actually getting the right click menu to show up

    turns out, there isn't an API to create a context menu. You add it via *Preferences*...
    [[./doc/img/ss-002.png]]

    *Toolbar*...
    [[./doc/img/ss-003.png]]

    ...*books in the calibre library*...
    [[./doc/img/ss-004.png]]

    and move it to the right pane.
    [[./doc/img/ss-005.png]]

    
**** testing the right click menu

     now a right click gives this menu:

     [[./doc/img/ss-006.png]]

     with this popup:

     [[./doc/img/ss-007.png]]
    


     next... we need to replace the TODO with the book info.
